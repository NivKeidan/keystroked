---
import { getCollection } from 'astro:content';
import BaseLayout from './BaseLayout.astro';
import PostCard from '../components/PostCard';
import AsciiArt from '../components/AsciiArt';
import { Badge } from '../components/ui/badge';
import { ArrowLeft, Facebook, Twitter, Linkedin, Link2 } from 'lucide-react';
import { type CollectionEntry } from 'astro:content';

type Props = CollectionEntry<'blog'>['data'];

const { title, slug, excerpt, pubDate, asciiArt, tags } = Astro.props;

// Format date for header
const headerDate = pubDate.toLocaleDateString('en-US', {
  month: 'long',
  day: 'numeric',
  year: 'numeric',
});

// Get related posts (exclude current post, get 2 others)
const allPosts = await getCollection('blog');
const relatedPosts = allPosts
  .filter(post => post.id !== slug)
  .slice(0, 2)
  .map(post => ({
    slug: post.id,
    title: post.data.title,
    excerpt: post.data.excerpt,
    date: post.data.pubDate.toLocaleDateString('en-US', { 
      month: 'short',
      day: 'numeric',
      year: 'numeric',
    }),
    readTime: post.data.readTime,
    asciiArt: post.data.asciiArt,
    tags: post.data.tags,
  }));

// Get current URL for sharing
const currentUrl = Astro.url;
const shareUrl = currentUrl.href;
const shareTitle = encodeURIComponent(title);
---

<BaseLayout title={`keystroked | ${title}`}>
  <header class="bg-background border-b border-border">
    <div class="container mx-auto px-6 py-12 2xl:w-[1400px]">
      <a href="/keystroked" class="inline-flex items-center gap-2 text-muted-foreground hover:text-primary transition-colors mb-8 group">
        <ArrowLeft className="w-4 h-4 group-hover:-translate-x-1 transition-transform" />
        <span class="font-mono text-sm">Back to posts</span>
      </a>

      <div class="grid md:grid-cols-2 gap-12 items-stretch">
        <div class="w-full h-full">
          <div class="w-full h-full p-8 bg-card rounded-xl border border-border flex items-center justify-center min-h-[400px]">
            <AsciiArt art={asciiArt} size="lg" />
          </div>
        </div>

        <div class="space-y-6">
          {tags.length > 0 && (
            <div class="flex flex-wrap gap-2">
              {tags.map((tag) => (
                <Badge className="font-mono text-xs bg-accent text-background px-3 py-1 rounded-full border border-transparent transition-colors">
                  {tag}
                </Badge>
              ))}
            </div>
          )}
          
          <h1 class="font-mono text-3xl md:text-4xl lg:text-5xl font-bold text-foreground leading-tight">
            {title}
          </h1>
          
          <p class="text-foreground text-lg leading-relaxed">
            {excerpt}
          </p>
          
          <div class="space-y-2">
            <p class="text-foreground text-sm">Posted {headerDate}</p>
          </div>
          
          <div class="flex items-center gap-3 pt-2">
            <a 
              href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="w-10 h-10 rounded-full border border-accent bg-background flex items-center justify-center text-foreground hover:bg-terminal-amber hover:text-black transition-colors"
              aria-label="Share on Facebook"
            >
              <Facebook className="w-5 h-5" />
            </a>
            <a 
              href={`https://twitter.com/intent/tweet?text=${shareTitle}&url=${encodeURIComponent(shareUrl)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="w-10 h-10 rounded-full border border-accent bg-background flex items-center justify-center text-foreground hover:bg-terminal-amber hover:text-black transition-colors"
              aria-label="Share on X (Twitter)"
            >
              <Twitter className="w-5 h-5" />
            </a>
            <a 
              href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(shareUrl)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="w-10 h-10 rounded-full border border-accent bg-background flex items-center justify-center text-foreground hover:bg-terminal-amber hover:text-black transition-colors"
              aria-label="Share on LinkedIn"
            >
              <Linkedin className="w-5 h-5" />
            </a>
            <button
              data-copy-url={shareUrl}
              class="copy-link-btn w-10 h-10 rounded-full border border-accent bg-background flex items-center justify-center text-foreground hover:bg-terminal-amber hover:text-black transition-colors cursor-pointer"
              aria-label="Copy link"
            >
              <Link2 className="w-5 h-5" />
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>
  <div class="blog-content">
    <article class="container px-4 lg:pl-12 lg:pr-4 pb-16 2xl:w-[1400px] prose max-w-3xl mx-4 md:ml-85 md:mr-auto text-lg prose-p:my-6 leading-[1.8] prose-h2:mt-16 prose-h2:mb-6 prose-h3:mt-12 prose-h3:mb-4">
        <slot />
      </article>
  </div>

  <section class="border-t border-border bg-muted/20">
    <div class="container mx-auto px-6 py-8 2xl:w-[1400px]">
      <h2 class="font-mono text-xl font-bold text-foreground mb-4">Related Posts</h2>
      <div class="grid md:grid-cols-2 gap-4">
        {relatedPosts.map((post) => (
          <PostCard 
            slug={post.slug}
            title={post.title}
            excerpt={post.excerpt}
            date={post.date}
            readTime={post.readTime}
            asciiArt={post.asciiArt}
            tags={post.tags}
            compact
          />
        ))}
      </div>
    </div>
  </section>
  <script>
    import { toast } from "sonner";
    document.addEventListener('DOMContentLoaded', () => {
      const copyBtn = document.querySelector('.copy-link-btn');
      if (copyBtn) {
        copyBtn.addEventListener('click', async () => {
          const url = copyBtn.getAttribute('data-copy-url');
          if (url) {
            try {
              await navigator.clipboard.writeText(url);
              toast('Link copied!');
            } catch (err) {
              console.error('Failed to copy:', err);
            }
          }
        });
      }
    });
  </script>
</BaseLayout>
